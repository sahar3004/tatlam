"""
Trinity Security Doctrine (תורת ההפעלה - תתל"מ Trinity)
Based on Deep Security Research 2025.
Source of Truth for: Writer (Claude), Judge (Gemini), Simulator (Llama/Qwen).
"""

TRINITY_DOCTRINE = {
    # פרק 1: ניתוח איום הייחוס 2025
    "threat_matrix": {
        "foot_assault": {
            "suicide_bomber": {
                "belt": {
                    "payload": "3-5 ק\"ג חנ\"מ + רסס (ברגים/מסמרים)",
                    "indicators": "נפח חריג באזור המותניים/טורסו, אי-פרופורציה בגוף"
                },
                "backpack": {
                    "payload": "6-10 ק\"ג חנ\"מ",
                    "indicators": "הליכה כבדה, מסורבלת, חתימת תנועה (Kinetic Signature) איטית"
                },
                "tiny_ied": {
                    "payload": "0.5 ק\"ג או גודל רימון 26/פחית",
                    "hiding_spot": "מוסתר בכבודה/תיק צד",
                    "detection": "מחייב שיקוף או חיפוש ידני, קשה לזיהוי ויזואלי"
                }
            },
            "active_shooter_cold_weapon": {
                "weapons": ["אקדח (אחוד/מפורק)", "סכין", "גרזן", "מברג"],
                "range": "טווח קצר (Point-blank)",
                "behavioral_indicators": [
                    "תסמונת הצייד (Dread)",
                    "סריקה מהירה של השטח",
                    "קיבעון (Fixation) על המאבטח",
                    "הסתרת יד דומיננטית"
                ]
            }
        },
        "vehicle_threats": {
            "vbied_types": {
                "motorcycle": {"capacity": "50 ק\"ג", "risk": "עקיפת מחסומים סטטיים"},
                "car": {"capacity": "300 ק\"ג"},
                "van": {"capacity": "500 ק\"ג"},
                "truck": {"capacity": "1,000 ק\"ג (1 טון)", "risk": "מוטות מבנים/גשרים"}
            },
            "indicators": [
                "שקיעת מתלים (Suspension sag)",
                "לוחיות רישוי אינן תואמות",
                "ריח חריג (דלק/חומצה)",
                "רכב חונה בציר חירום/גשר"
            ],
            "ramming": {
                "mass": "עד 10 טון",
                "speed": "60 קמ\"ש",
                "target": "הולכי רגל/עמודי נגיפה",
                "vector": "סטייה חדה מתוואי כביש"
            }
        },
        "aerial_threats": {
            "drones": {
                "types": ["רחפן מסחרי (COTS)", "רחפן בבנייה עצמית (250 גרם+)"],
                "tactics": ["הטלת חימוש (רימון)", "רחפן מתאבד", "נחילים (עד 5 במקביל)"],
                "envelope": "גובה עד 300 רגל (90 מ'), רדיוס 100 מ'"
            },
            "high_angle_fire": "ירי נק\"ל/נ\"ט מגגות שולטים או ירי תלול מסלול (רקטות)"
        },
        "infrastructure_hazmat": {
            "hazmat_leech": "מטען 'עלוקה' (250 גרם) מוצמד למיכל חומר מסוכן",
            "sabotage": ["חיתוך סיבים/חשמל", "שיבוש שו\"ב", "הנחת מכשול למסילה (שימוט)"]
        }
    },

    # פרק 2: זירת הפעולה - תחנת אלנבי
    "venue_allenby": {
        "specs": {
            "depth": "28 מטר מתחת לקרקע",
            "type": "מערכת פתוחה עם סינון סלקטיבי"
        },
        "levels": {
            "surface": {
                "name": "מפלס הרחוב",
                "features": ["3 כניסות (הרכבת, מקווה ישראל, אלנבי)", "פיר מעלית אחורי"],
                "defenses": "עמודי נגיפה הידראוליים (HVM)"
            },
            "minus_1": {
                "name": "קומת כרטוס (Concourse)",
                "assets": ["חדר בקרת תחנה (SMR)", "חדר שנאים", "שערי גבייה"],
                "risk": "השתלטות על SMR = עיוורון מצלמות ושליטה בדלתות"
            },
            "minus_2": {
                "name": "קומה טכנית",
                "status": "שטח סטרילי (אין כניסת נוסעים)",
                "alert_rule": "כל אדם בקומה זו = אירוע פריצה/פח\"ע מיידי"
            },
            "minus_3": {
                "name": "קומת רציפים",
                "vulnerabilities": ["מעבר שירות למסילה", "צפיפות קהל (Kill Zone)"],
                "assets": "חדרי תקשורת"
            }
        },
        "force_structure": "מינימום 2 מאבטחים (1 בכרטוס, 1 ברציף). הסתמכות על הפתעה ותווך.",
        "dead_zones": [
            "מדרגות חירום (הטמנת מטען)",
            "מסדרונות תפעוליים",
            "שירותים (הרכבת מטען לאחר בידוק)"
        ]
    },

    # פרק 3: סמכויות ומשפט (האלגוריתם של השופט)
    "legal_framework": {
        "search_authority": {
            "location": "רק בכניסה למתקן או מקום מוגדר בחוק",
            "scope": "גוף האדם (שטחי), בגדים, כלים, כלי תחבורה",
            "trigger": "שמירה על בטחון הציבור בלבד (לא אכיפה אזרחית)",
            "refusal_policy": "סירוב לחיפוש = מניעת כניסה בלבד (לא עילה למעצר)",
            "forced_search": {
                "condition": "חשד סביר בלבד (Reasonable Suspicion)",
                "definition": "למשל: סירוב + בליטה חשודה בבגד",
                "action": "שימוש בכוח סביר"
            }
        },
        "detainment_authority": {
            "conditions": ["חשד לנשיאת נשק שלא כדין", "חשד לשימוש בנשק", "אלימות/סכנה לציבור"],
            "duration": "עד הגעת שוטר (זמן סביר). רף עליון סטטוטורי: 3 שעות",
            "force": "כוח סביר למימוש העיכוב במקרה התנגדות"
        },
        "identification": {
            "rule": "מותר לדרוש תעודה בכניסה",
            "profiling_ban": "איסור מוחלט על דרישה על בסיס גזע, דת, מוצא, דעה פוליטית. חריגה = ציון 0 בשיפוט."
        },
        "open_fire_regulations": {
            "core_principle": "אמצעי אחרון (Ultima Ratio)",
            "conditions": [
                "סכנת חיים ממשית ומיידית (Life Threat)",
                "זיהוי אמצעי (Means) + כוונה (Intent)"
            ],
            "prohibitions": [
                "אסור לירות להגנה על רכוש",
                "אסור לירות להגנה על סדר ציבורי",
                "אסור לירות בגב של בורח שאינו מסכן חיים"
            ],
            "exceptions": "מיידי אבנים/בקת\"ב - רק בטווח מסכן חיים מיידי"
        }
    },

    # פרק 4: פרוטוקולי פעולה (SOPs)
    "procedures": {
        "suspicious_object": {
            "classification": {
                "abandoned": "מקום טבעי, חפץ תמים, ניתן לאיתור בעלים",
                "suspicious": "מוסתר, כבד, חוטים/אורות, ריח שקדים/דלק, מיקום רגיש (עמוד תומך)"
            },
            "actions_donts": ["אסור לגעת!", "אסור להזיז/לפתוח", "אסור להשתמש בקשר/סלולר ליד החפץ"],
            "actions_dos": ["בידוד זירה", "חסימה", "דיווח", "סריקה למטען משני", "טיפול ע\"י חבלן בלבד"],
            "safety_distances": {
                "object_urban": "50 מטר (מאחורי מחסה)",
                "object_open": "100 מטר",
                "car": "100 מטר ומעלה",
                "truck": "עד 400 מטר"
            }
        },
        "hostile_event_peh_hey_ay": {
            "flow": [
                "1. זיהוי (אימות אמצעי וכוונה)",
                "2. דיווח (קוד מצוקה + מיקום)",
                "3. חתירה למגע (צמצום טווח, ניצול מחסות)",
                "4. נטרול (ירי סלקטיבי, זהירות על קהל)",
                "5. סיום איום (הרחקה מנשק, כבילה)",
                "6. טיפול רפואי (רק לאחר זיכוי זירה)"
            ]
        },
        "public_disturbance": {
            "level_a_quiet": "מחאה שקטה/שלטים -> לא להתערב",
            "level_b_soft": "צעקות/הפרעה לתנועה -> אזהרה, מניעת כניסה",
            "level_c_violent": "ונדליזם/תקיפה -> כוח סביר, הרחקה, משטרה",
            "red_line": "אסור להשתמש בנשק חם לפיזור הפגנה"
        },
        "emergency_routine": {
            "routine": "סריקות ביטחון כל שעתיים (כולל שטחים מתים)",
            "missile_alert": "פתיחת שערים, הכוונה לקומות -2/-3 (מקלט)",
            "fire": "נוהל אש, פינוי נגד כיוון העשן, חסימת כניסות"
        }
    },

    # פרק 5: לוגיקת שיפוט וניקוד
    "scoring_logic": {
        "safety": {
            "pass": "שמירה על טווחי בטיחות, אי-מגע בחפץ",
            "fail": "נגיעה בחפץ חשוד (ציון 0 מיידי), כניסה לטווח סכנה"
        },
        "legality": {
            "pass": "כוח סביר, ירי מוצדק, עיכוב חוקי",
            "fail": "ירי ללא סכנת חיים, אפליה, עיכוב מעל 3 שעות"
        },
        "tactics": {
            "pass": "חתירה למגע בפח\"ע, בידוד בחפץ חשוד",
            "fail": "בריחה בפח\"ע, הסתערות על חפץ חשוד"
        }
    }
}

def get_system_prompt(role: str) -> str:
    """
    בונה את הנחיית המערכת (System Prompt) באופן דינמי מתוך הדוקטרינה.
    """
    base = (
        "אתה חלק ממערכת 'תתל\"מ Trinity' לאימון ביטחוני.\n"
        "עליך לפעול אך ורק לפי 'תורת ההפעלה' (Doctrine) המוגדרת להלן.\n"
        "כל חריגה מהנהלים, המשקלים או הסמכויות תחשב לכישלון.\n\n"
    )

    # Critical language guardrails to prevent hallucinations
    language_guard = (
        "\n\n*** הנחיות קריטיות לשפה (CRITICAL LANGUAGE INSTRUCTIONS) ***\n"
        "1. עליך להגיב אך ורק בעברית (Hebrew ONLY).\n"
        "2. אין להשתמש בסינית, ערבית, גרמנית או כל שפה אחרת.\n"
        "3. גם אם יש מונחים באנגלית בהנחיות, התשובה שלך חייבת להיות בעברית מלאה.\n"
        "4. שמור על דמות אמינה ומקצועית."
    )

    if role == "writer":
        return base + f"""
        תפקידך: הכותב (The Architect).
        עליך לייצר תרחישים המבוססים על:
        1. איומים: {TRINITY_DOCTRINE['threat_matrix']}
        2. זירה (תחנת אלנבי): {TRINITY_DOCTRINE['venue_allenby']}

        השתמש בנתונים המדויקים (למשל: משקל מטען, גובה רחפן, שמות הקומות).
        נצל את השטחים המתים של התחנה.
        """ + language_guard

    elif role == "judge":
        return base + f"""
        תפקידך: השופט (The Adjudicator).
        עליך לבקר את ביצועי המאבטח לפי:
        1. מסגרת משפטית וסמכויות: {TRINITY_DOCTRINE['legal_framework']}
        2. נהלי פעולה (SOPs): {TRINITY_DOCTRINE['procedures']}
        3. טבלת ניקוד: {TRINITY_DOCTRINE['scoring_logic']}

        החמר מאוד בענייני בטיחות (נגיעה בחפץ) וחוקיות (ירי לא מוצדק).
        """ + language_guard

    elif role == "simulator":
        return base + f"""
        תפקידך: הסימולטור (היריב/האזרח).
        עליך לגלם דמויות הפועלות לפי הפרופילים ב-Threat Matrix:
        {TRINITY_DOCTRINE['threat_matrix']}

        אם אתה אזרח: דרוש את זכויותיך (סירוב לחיפוש ללא חשד סביר).
        אם אתה מחבל: פעל לפי האינדיקטורים (לבוש חריג, לחץ) ונצל את חולשות המבנה.
        """ + language_guard

    return base + language_guard
